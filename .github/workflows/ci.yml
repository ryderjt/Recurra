name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Cache Xcode build artifacts
      uses: actions/cache@v3
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData
          ~/Library/Caches/com.apple.dt.Xcode
        key: ${{ runner.os }}-xcode-${{ hashFiles('**/project.pbxproj') }}
        restore-keys: |
          ${{ runner.os }}-xcode-
          
    - name: Build Debug
      run: |
        cd Recurra
        xcodebuild -project Recurra.xcodeproj \
          -scheme Recurra \
          -configuration Debug \
          -destination "platform=macOS" \
          build
          
    - name: Build Release
      run: |
        cd Recurra
        xcodebuild -project Recurra.xcodeproj \
          -scheme Recurra \
          -configuration Release \
          -destination "platform=macOS" \
          build
          
    - name: Archive
      run: |
        cd Recurra
        xcodebuild -project Recurra.xcodeproj \
          -scheme Recurra \
          -configuration Release \
          -destination "platform=macOS" \
          -archivePath Recurra.xcarchive \
          archive
          
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: Recurra-archive
        path: Recurra/Recurra.xcarchive
        retention-days: 7

  test:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Run tests
      run: |
        cd Recurra
        xcodebuild test \
          -project Recurra.xcodeproj \
          -scheme Recurra \
          -destination "platform=macOS" \
          -resultBundlePath TestResults.xcresult
          
    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results
        path: Recurra/TestResults.xcresult
        retention-days: 7

  lint:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Install SwiftLint
      run: |
        brew install swiftlint
        
    - name: Run SwiftLint
      run: |
        cd Recurra/Recurra
        swiftlint lint --reporter github
